---
title: "Arabidopsis_mutatnts_col"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(magrittr)
library(edgeR)
```

```{r}
geneCounts <- read_delim("4_Counts/Ying_Submergence_batch1_final.txt", 
                         delim = "\t", 
                         comment = "#") %>% 
  column_to_rownames("Geneid")
colnames(geneCounts) %<>% str_remove("../3_BAM/") %>% str_remove(".STARAligned_TAIR10.sortedByCoord.bam")

# crate meta data
meta <- tibble(sample = colnames(geneCounts),
               submergence = str_extract(sample,"cont|sub"), 
               genotype = str_extract(sample,".+(?=-(cont|sub))"),
               reps = str_extract(sample,"(?<=(cont|sub)-).+"),
               group = paste(genotype, submergence, sep = "_") # this info will fill to 'group' as col name match 'group' pram in DGEList() and converting to a single factor Exp
)

countList <- DGEList(counts = geneCounts,
                     samples = meta) 

keep <- filterByExpr(countList)
table(keep)
countList <- countList[keep,, keep.lib.sizes=FALSE] %>% 
  calcNormFactors()

# set control group as reference 
countList$samples$group <-   relevel(countList$samples$group, ref = "Col_cont")
```

```{r mds}
# visualize sample clustering, alternatively PCA can do the job
mds <- plotMDS(countList, method="bcv", col=as.numeric(countList$samples$group))
# make it easy to change appearance 
mds %>%
  extract(c(5,6)) %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  left_join(meta) %>%
  ggplot(aes(x = x, y = y)) +
  geom_point(aes(colour  = genotype,
                 shape = submergence), 
             size = 3) +
  theme_bw() +
  labs(x = "BCV distance 1",
       y = "BCV distance 2")
```

```{r estimating dispersions}
# if with multiple factors, dispersion needs to be estimated with specified design matrix (see section 2.10.2 in edgeR user's guide updated in 21 Oct. 2019)
counts_Disp <- estimateDisp(countList)
plotBCV(counts_Disp)
```

```{r model fitting and contrast making}
# contract a design matrix with baseline control
designMat <- model.matrix(~ 0 + group, data = countList$samples)
colnames(designMat) <- levels(countList$samples$group)

# fit to model
fit <- glmQLFit(counts_Disp, design = designMat)

myContrast <- makeContrasts(wt = Col_sub - Col_cont,
                            levels = designMat)
```

```{r}
wt <- glmQLFTest(fit, contrast = myContrast[,"wt"])
wtGenes <- wt$table %>% 
  rownames_to_column("GeneID") %>% 
  mutate(adj.p = p.adjust(PValue, method = "BH"))

wtGenes %>% 
  mutate(expression = ifelse(adj.p < 0.05 & abs(logFC) >= 1, 
                             ifelse(logFC > 1 ,'Up','Down'),
                             'Stable')) %>% 
  ggplot(aes(x = logFC, 
             y = -log10(adj.p), 
             colour = expression)) +
  geom_point(alpha = 0.4, size = 3.5) +
  scale_color_manual(values=c("blue", "grey","red"))+
  xlim(c(-16, 16)) +
  geom_vline(xintercept = c(-1,1),
             lty=4,col="black",
             lwd=0.8) +
  geom_hline(yintercept = -log10(0.05),
             lty=4,col="black",
             lwd=0.8) +
  labs(x="log2(fold change)",
       y="-log10 (adj.p-value)")  +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position="right", 
        legend.title = element_blank())
```

